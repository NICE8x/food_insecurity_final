---
title: "US Food Insecurity Rate with Demographic Indicators"
output: html_document
runtime: shiny
---

```{r message=FALSE, warning=FALSE, echo=FALSE}
library(tidyverse)
library(plotly)
library(rjson)
library(rvest)
library(httr)
library(usdata)
library(shiny)
library(leaflet)
library(RColorBrewer)
library(maptools)
library(readr)
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
race_2017_df <- read_csv("race_hisp_df.csv")

edu_2017_df <- read_csv("mtm_2017_edu_2017_att_df.csv") 
edu_2017_df <- edu_2017_df %>%
  select(geo_id, fi_rate, county_state, less_9th, nineth_to_12th, hs_grad, some_coll, assoc_deg, bach_deg, grad_or_prof)

insurance_2017_df <- read_csv("mtm_2017_ins_2017_status_df.csv")
income_2017_df <- read_csv("mtm_2017_income_2017_brac_df.csv")

  
final_demographics_df  = inner_join(x = edu_2017_df, y = race_2017_df, by = "geo_id", all = TRUE)
final_demographics_df =  inner_join(x = final_demographics_df, y = insurance_2017_df, by = "geo_id", all = TRUE)
final_demographics_df = inner_join(x = final_demographics_df, y = income_2017_df, by = "geo_id", all = TRUE)
    
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
# race input
selectInput(
  "Racial Indicators",
  h3("Racial Indicators"),
  choices = c("Food Insecurity Rate" = "fi_rate", "White" = "white", "Black" = "black", "American Indian/Alaska Native" = "am_ind_al_nat", "Native Hawaiian or Other Pacific Islander" = "nat_ha_pac_isl", "other" = "other", "Two or More races" = "two_or_more" )
)

renderPrint(
  input[["Racial Indicators"]]
)


# education level input
selectInput(
  "Education Indicators",
  h3("Education Indicators"),
  choices = c("Food Insecurity Rate" = "fi_rate", "Less than 9th Grade" = "estimate_total_less_than_9th_grade" )
)

renderPrint(
  input[["Demographic Indicators"]]
)


# income level input
selectInput(
  "Income Level Indicators",
  h3("Income Level Indicators"),
  choices = c("Food Insecurity Rate" = "fi_rate",  )
)

renderPrint(
  input[["Demographic Indicators"]]
)

# insurance status input
selectInput(
  "Education Indicators",
  h3("Education Indicators"),
  choices = c("Food Insecurity Rate" = "fi_rate",  )
)

renderPrint(
  input[["Demographic Indicators"]]
  
  
# state input
selectInput(
  "state",
  h3("State"),
  choices = list("USA", "AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DC", "DE", "FL", "GA", "HI", "ID", "IL", "IN", "IA","KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY")
)

renderPrint(
  input[["state"]]
)

url <- 'https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json'
counties <- rjson::fromJSON(file=url)

g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

```


```{r message=FALSE, warning=FALSE, echo=FALSE}
url <- 'https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json'
counties <- rjson::fromJSON(file=url)

g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)
```


```{r message=FALSE, warning=FALSE, echo=FALSE}
renderPlotly({
if(input[["state"]] != "USA"){
  
z_df %>% 
  dplyr::filter(year == rlang::sym(input[["year"]]))%>%
  dplyr:: filter(state == input[["state"]]) %>%
plot_ly() %>% 
  add_trace(
    type="choropleth",
    geojson=counties,
    locations=~(fips),
    z=~(eval(as.name(input[["food insecurity metric"]]))), 
    text = ~county_state,
    colorscale="Viridis",
    zmin=0,
    zmax=case_when(
  input[["food insecurity metric"]] == "fi_rate" ~ 40,
),
    marker=list(line=list(
      width=0)
    )
  ) %>%
  colorbar(title = case_when(
  input[["food insecurity metric"]] == "fi_rate" ~ "Food Insecurity Rate (%)"
)
           ) %>% 
  layout(
    title = "US Food Insecurity Metrics by Education Level",
    geo = g
)

}


else{
  
z_df %>% 
  dplyr::filter(year == rlang::sym(input[["year"]]))%>%
plot_ly() %>% 
  add_trace(
    type="choropleth",
    geojson=counties,
    locations=~(fips),
    z=~(eval(as.name(input[["food insecurity metric"]]))), 
    text = ~county_state,
    colorscale="Viridis",
    zmin=0,
    zmax=case_when(
  input[["food insecurity metric"]] == "fi_rate" ~ 40,
 
),
    marker=list(line=list(
      width=0)
    )
  ) %>%
    
  colorbar(title = case_when(
  input[["food insecurity metric"]] == "fi_rate" ~ "Food Insecurity Rate (%)",
  
)
           ) %>% 
  layout(
    title = "US Food Insecurity Metrics by Education Level",
    geo = g
)
}
}
  )
```

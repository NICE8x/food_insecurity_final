---
title: "interactive_plot_demographics"
author: "Stella Li"
date: "11/25/2020"
output: html_document
runtime: shiny
---

```{r warning=FALSE}
library(tidyverse)
library(plotly)
library(rjson)
library(rvest)
library(httr)
library(usdata)
library(shiny)
library(leaflet)
library(RColorBrewer)
library(maptools)
```



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r eruptions, echo=FALSE}
inputPanel(
  selectInput("n_breaks", label = "Number of bins:",
              choices = c(10, 20, 35, 50), selected = 20),
  
  sliderInput("bw_adjust", label = "Bandwidth adjustment:",
              min = 0.2, max = 2, value = 1, step = 0.2)
)

renderPlot({
  hist(faithful$eruptions, probability = TRUE, breaks = as.numeric(input$n_breaks),
       xlab = "Duration (minutes)", main = "Geyser eruption duration")
  
  dens <- density(faithful$eruptions, adjust = input$bw_adjust)
  lines(dens, col = "blue")
})
```

## Embedded Application

It's also possible to embed an entire Shiny application within an R Markdown document using the `shinyAppDir` function. This example embeds a Shiny application located in another directory:

```{r tabsets, echo=FALSE}
shinyAppDir(
  system.file("examples/06_tabsets", package = "shiny"),
  options = list(
    width = "100%", height = 550
  )
)
```

Note the use of the `height` parameter to determine how much vertical space the embedded application should occupy.

You can also use the `shinyApp` function to define an application inline rather then in an external directory.

In all of R code chunks above the `echo = FALSE` attribute is used. This is to prevent the R code within the chunk from rendering in the document alongside the Shiny components.



Import FIPS data (https://mdreducation.com/ >pdfs > US_FIPS_Codes), tidy it and join it to the map the meal gap data.

```{r fips data}
fips_df = readxl::read_xls("./fips_data/US_FIPS_Codes.xls", skip = 1) %>%
  janitor::clean_names() %>%
  rename(county = county_name) %>%
  unite("fips", c("fips_state", "fips_county"), sep = "") %>%
  mutate(county = tolower(county),
         state = state2abbr(state),
         county = str_replace(county, ",.*", ""),
         county = str_replace(county, "\\scounty",""),
         county = str_replace(county, "\\sparish",""),
         county = str_replace(county, "\\sborough", ""),
         county = str_replace(county, "\\scensus area", ""),
         county = str_replace(county, "\\smunicipality of", ""),
         county = str_replace(county, "dona ana", "doÃ±a ana"),
         county = str_replace(county, "^st\\s|^st\\.", "saint "),
         county = str_replace(county, "de kalb", "dekalb")
  ) %>%
unite("county_state", c("county", "state"), sep = "_", remove = FALSE) %>%
  mutate(county_state = str_replace(county_state, "prince of wales-outer ketchikan_AK", "prince of wales-hyder_AK"),
         county_state = str_replace(county_state, "matanuska susitna_AK", "matanuska-susitna_AK"),
         county_state = str_replace(county_state, "valdez cordova_AK", "valdez-cordova_AK"),
         county_state = str_replace(county_state, "juneau_AK", "city and of juneau_AK"),
         county_state = str_replace(county_state, "dekalb_TN", "de kalb_TN"),
         county_state = str_replace(county_state, "dekalb_IN", "de kalb_IN"),
         county_state = str_replace(county_state, "dewitt_IL", "de witt_IL"),
         county_state = str_replace(county_state, "de soto_MS", "desoto_MS"),
         county_state = str_replace(county_state, "de soto_FL", "desoto_FL"),
         county_state = str_replace(county_state, "du page_IL", "dupage_IL"),
         county_state = str_replace(county_state, "skagway hoonah angoon_AK", "hoonah-angoon_AK"),
         county_state = str_replace(county_state, "skagway hoonah angoon_AK", "hoonah-angoon_AK"),
         county_state = str_replace(county_state, "wrangell petersburg_AK", "petersburg_AK"),
         county_state = str_replace(county_state, "prince georges_MD", "prince george's_MD"),
         county_state = str_replace(county_state, "prince wales ketchikan_AK", "prince of wales-hyder_AK"),
         county_state = str_replace(county_state, "queen annes_MD", "queen anne's_MD"),
         county_state = str_replace(county_state, "radford_VA", "radford city_VA"),
         county_state = str_replace(county_state, "saint marys_MD", "saint mary's_MD"),
         county_state = str_replace(county_state, "yukon koyukuk_AK", "yukon-koyukuk_AK")
) %>%
  select(county_state, fips)


map_the_meal_gap_df = read_csv("./map_the_meal_gap_df.csv")

mtm_fips_df = left_join(map_the_meal_gap_df, fips_df, by = "county_state") %>%
  drop_na(fips)

new_DF <- mtm_fips_df[is.na(mtm_fips_df$fips),]

```



Plotly of Food Insecurity Rate in 2017

```{r plot attempt}
url <- 'https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json'
counties <- rjson::fromJSON(file=url)

g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

z_df = mtm_fips_df %>% 
  filter(year == 2017) %>%
  mutate(fi_rate = fi_rate * 100)

fig <- plot_ly()
fig <- fig %>% add_trace(
    type="choropleth",
    geojson=counties,
    locations=z_df$fips,
    z=z_df$fi_rate,
    colorscale="Viridis",
    zmin=0,
    zmax=40,
    marker=list(line=list(
      width=0)
    )
  )
fig <- fig %>% colorbar(title = "Food Insecurity Rate (%)")
fig <- fig %>% layout(
    title = "2017 US Food Insecurity Rate by County"
)

fig <- fig %>% layout(
    geo = g
  )

fig
```




Plotly of Food Insecurity Rate for Each Year

```{r plot attempt 2}

year_choices = mtm_fips_df %>%
mutate(year = factor(year, levels = c("2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017"))) %>%
pull(year) %>% 
  unique()

selectInput(
  "year",
  h3("Year"),
  choices = year_choices
)

renderPrint(
  input[["year"]]
)

url <- 'https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json'
counties <- rjson::fromJSON(file=url)

g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

renderPlotly({
z_df = mtm_fips_df %>% 
  filter(year == input[["year"]]) %>%
  mutate(fi_rate = fi_rate * 100)

fig <- plot_ly()
fig <- fig %>% add_trace(
    type="choropleth",
    geojson=counties,
    locations=z_df$fips,
    z=z_df$fi_rate,
    colorscale="Viridis",
    zmin=0,
    zmax=40,
    marker=list(line=list(
      width=0)
    )
  )
})
fig <- fig %>% colorbar(title = "Food Insecurity Rate (%)")
fig <- fig %>% layout(
    title = "US Food Insecurity Rate by County"
)

fig <- fig %>% layout(
    geo = g
  )

fig
```



```{r}
#Specify shinyApp(ui, server)
shinyApp(options = list(height = 1000), 
         
         #Define the user interface element
         ui = fluidPage(
           titlePanel("Health Indicators in New York City"),
           fluidRow(
             column(8
                    
                    #Create element to allow user input. 
                    , selectInput('category', 'Select Category'
                                  , choices = unique(Data$Category)
                    )
                    #render ui elements within the server function. 
                    , uiOutput('measures'))
             
             , column(4, uiOutput('slider')
                      
             )
           ),
           
           fluidRow(column(12, leafletOutput('mymap', height = 550))
           )
         )
         
         #Define functionality
         ,server = function(input, output, session){
           
           
           #Read the data into a reactive function. 
           df1 = reactive ({
             df = Data
             df = subset(df, select = c('CityName','StateAbbr', 'GeoLocation', 'Year'
                                        , 'Measure', 'Data_Value', 'PopulationCount', 'GeographicLevel'
                                        , 'Short_Question_Text', 'Category', 'DataValueTypeID'))
             
             #Removes NA values
             df = df[!is.na(df$Data_Value),]
             
             df = subset(df, Category == input$category)
             #df = subset(df, GeographicLevel == as.character(input$geoLevel))
           })
           
           #renderUI to dynamically generate ui elements. 
           output$measures = renderUI({
             selectInput('measures', 'Select Measure', choices = unique(df1()$Measure))
           })
           
           #Filter the data again based on the measure chosen by the user. 
           df2 = reactive ({
             x = df1()
             x = subset(x, Measure == as.character(input$measures))
           })
           
           #Create a slider to filter the map markers. 
           output$slider = renderUI ({
             sliderInput('slider', 'Filter Based on Percentage', min = min(df2()$Data_Value) 
                         , max = max(df2()$Data_Value)
                         , value = c(min(df2()$Data_Value), max(df2()$Data_Value)))
           })
           
           #Build the leaflet map
           output$mymap = renderLeaflet({
             df = df2()
             
             #Filter the data set based on values from the slider input
             df = subset(df, Data_Value > input$slider[1] & Data_Value < input$slider[2])
             
             #Define color pallete
             Colors = brewer.pal(8,"Set2")
             
             #Apply pallete to values from data set
             binpal = colorBin(Colors, df$Data_Value, 6, pretty = FALSE)
             
             #Separate GeoLocation column into latitude and longitude columns. 
             lat = vector()
             lng = vector()
             for (i in 1: nrow(df)){
               x= unlist(strsplit(df$GeoLocation[i], ",")) 
               lat[i] = substr(x[1],2,8) 
               lng[i] = substr(x[2],2,9) 
               
             }
             
             df$lat = as.numeric(lat)
             df$lng = as.numeric(lng)
             
             #Build leaflet map
             leaflet() %>%
               
               #Adds state borders to the map
               addTiles(
                 urlTemplate = "//{s}.tiles.mapbox.com/v3/jcheng.map-5ebohr46/{z}/{x}/{y}.png",
                 attribution = 'Maps by <a href="http://www.mapbox.com/">Mapbox</a>'
               ) %>%
               
               #Add the markers for each location
               addCircleMarkers(lat = df$lat
                                , lng = df$lng
                                , data = df
                                , label = paste(df$Data_Value)
                                , color = ~binpal(Data_Value)
                                , radius = 5
                                , fillColor = ~binpal(Data_Value)
                                , fill = TRUE
                                , opacity = 0.8
                                
               ) %>%
               addLegend(position = 'bottomleft', pal = binpal, values = df$Data_Value, title = "Percentage"
               )
             
           })
           
           
           
         }
)
```



```{r warning=FALSE}
race_df = 
  read_csv("ACS_data/ACS_2017_race.csv") %>%
  rename(
    total = "K200201_001E",
    white = "K200201_002E",
    black = "K200201_003E",
    am_ind_al_nat = "K200201_004E",
    asian = "K200201_005E",
    nat_ha_pac_isl = "K200201_006E",
    other = "K200201_007E",
    two_or_more = "K200201_008E",
    county_state = "NAME"
  ) %>%
  janitor::clean_names()
```



